---
- name: testing to add ssh key and add user account
  hosts: test-ansible
  remote_user: ubuntu
  become: yes
  vars: 
    ssh_pubkey: "{{lookup('file', '/var/jenkins_home/aws-key/deploy.pub')}}"
    new_user: test-ansible
   
  tasks:
    - name: test connection
      ping:
      remote_user: ubuntu

    - name: install python
      apt: 
        name: python
        state: present
        update_cache: yes
        install_recommends: yes
    
    - name: create user account
      user:
        name: "{{new_user}}"
        shell: /bin/bash
        groups: admin
        append: yes
    
    - name: create authorized_keys file and add ssh key
      copy: 
        content: "{{ssh_pubkey}}"
        dest: '/home/"{{new_user}}"/.ssh/authorized_keys'
    
    # - name: add ssh key to .ssh
    #   lineinfile:
    #     path: '/home/"{{new_user}}"/.ssh/authorized_keys'
    #     line: "{{ssh_pubkey}}"
    #     mode: 0600
    
    - name: install nginx
      apt: 
        name: nginx
        state: latest
        update_cache: yes
        install_recommends: yes
    
    - name: install postgresql
      apt: 
        pkg:
        - postgresql
        - postgresql-contrib
        